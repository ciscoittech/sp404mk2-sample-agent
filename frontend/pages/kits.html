<!DOCTYPE html>
<html lang="en" data-theme="business">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Kit Builder - SP404MK2 Sample Manager</title>

    <!-- DaisyUI + Tailwind -->
    <link href="https://cdn.jsdelivr.net/npm/daisyui@4.12.14/dist/full.min.css" rel="stylesheet">
    <script src="https://cdn.tailwindcss.com"></script>

    <!-- HTMX -->
    <script src="https://unpkg.com/htmx.org@2.0.4"></script>

    <!-- Alpine.js -->
    <script defer src="https://unpkg.com/alpinejs@3.x.x/dist/cdn.min.js"></script>

    <!-- Custom CSS -->
    <link rel="stylesheet" href="/static/css/main.css">
</head>
<body>
    <!-- Include Sidebar -->
    <div id="sidebar-container"></div>

    <!-- Kits Content Template -->
    <template id="kits-content">
        <main class="p-4 lg:p-8" x-data="kitBuilder()">
        <div class="kits-page">
            <!-- Page Header -->
            <div class="mb-8 flex justify-between items-center">
                <div>
                    <h1 class="text-3xl font-bold mb-2">Kit Builder</h1>
                    <p class="text-base-content/70">Organize your samples into SP-404MK2 kits</p>
                </div>
                <button class="btn btn-primary" @click="showCreateKitModal()">
                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"></path>
                    </svg>
                    New Kit
                </button>
            </div>

            <!-- Kit List / Kit Detail Toggle -->
            <div class="flex gap-4" x-show="!selectedKit">
                <div class="flex-1">
                    <h2 class="text-xl font-bold mb-4">Your Kits</h2>
                    <div id="kit-list"
                         hx-get="/api/v1/kits"
                         hx-trigger="load"
                         hx-swap="innerHTML">
                        <div class="loading loading-spinner loading-lg mx-auto"></div>
                    </div>
                </div>
            </div>

            <!-- Kit Detail View -->
            <div x-show="selectedKit" x-cloak>
                <div class="flex justify-between items-center mb-6">
                    <button class="btn btn-ghost btn-sm" @click="selectedKit = null">
                        ← Back to Kits
                    </button>
                    <div class="flex gap-2">
                        <button class="btn btn-sm btn-outline" @click="editKit()">Edit Kit</button>
                        <button class="btn btn-sm btn-primary" @click="exportKit()">Export ZIP</button>
                    </div>
                </div>

                <div class="mb-6">
                    <h2 class="text-2xl font-bold" x-text="selectedKit?.name"></h2>
                    <p class="opacity-70" x-text="selectedKit?.description"></p>
                </div>

                <!-- 16-Pad Grid (4x4) with Row Labels -->
                <div class="mb-4">
                    <div class="grid grid-cols-5 gap-3">
                        <!-- Header Row -->
                        <div></div>
                        <div class="text-center text-xs opacity-60 font-semibold">Pad 1</div>
                        <div class="text-center text-xs opacity-60 font-semibold">Pad 2</div>
                        <div class="text-center text-xs opacity-60 font-semibold">Pad 3</div>
                        <div class="text-center text-xs opacity-60 font-semibold">Pad 4</div>

                        <!-- Row 1: Loops (Pads 1-4) -->
                        <div class="text-right text-xs opacity-60 font-semibold flex items-center justify-end">
                            Loops
                        </div>
                        <template x-for="padNum in [1, 2, 3, 4]" :key="padNum">
                            <div class="card bg-base-300 hover:bg-base-200 transition-colors cursor-pointer"
                                 @click="showPadRecommendations(padNum)">
                                <div class="card-body p-4">
                                    <div class="text-xs opacity-60 mb-2" x-text="'Pad ' + padNum"></div>
                                    <template x-if="getPadSample(padNum)">
                                        <div>
                                            <div class="text-sm font-semibold truncate" x-text="getPadSample(padNum)?.sample?.title"></div>
                                            <div class="text-xs opacity-70">
                                                Bank <span x-text="getPadSample(padNum)?.pad_bank"></span>
                                            </div>
                                            <button
                                                class="btn btn-xs btn-error mt-2"
                                                @click.stop="removePadAssignment(padNum)"
                                            >
                                                Remove
                                            </button>
                                        </div>
                                    </template>
                                    <template x-if="!getPadSample(padNum)">
                                        <div>
                                            <div class="text-xs opacity-50 italic mb-2">Empty</div>
                                            <button class="btn btn-xs btn-outline">
                                                Assign
                                            </button>
                                        </div>
                                    </template>
                                </div>
                            </div>
                        </template>

                        <!-- Row 2: Textures (Pads 5-8) -->
                        <div class="text-right text-xs opacity-60 font-semibold flex items-center justify-end">
                            Textures
                        </div>
                        <template x-for="padNum in [5, 6, 7, 8]" :key="padNum">
                            <div class="card bg-base-300 hover:bg-base-200 transition-colors cursor-pointer"
                                 @click="showPadRecommendations(padNum)">
                                <div class="card-body p-4">
                                    <div class="text-xs opacity-60 mb-2" x-text="'Pad ' + padNum"></div>
                                    <template x-if="getPadSample(padNum)">
                                        <div>
                                            <div class="text-sm font-semibold truncate" x-text="getPadSample(padNum)?.sample?.title"></div>
                                            <button
                                                class="btn btn-xs btn-error mt-2"
                                                @click.stop="removePadAssignment(padNum)"
                                            >
                                                Remove
                                            </button>
                                        </div>
                                    </template>
                                    <template x-if="!getPadSample(padNum)">
                                        <div class="text-xs opacity-50 italic">Empty</div>
                                    </template>
                                </div>
                            </div>
                        </template>

                        <!-- Row 3: Accents (Pads 9-12) -->
                        <div class="text-right text-xs opacity-60 font-semibold flex items-center justify-end">
                            Accents
                        </div>
                        <template x-for="padNum in [9, 10, 11, 12]" :key="padNum">
                            <div class="card bg-base-300 hover:bg-base-200 transition-colors cursor-pointer"
                                 @click="showPadRecommendations(padNum)">
                                <div class="card-body p-4">
                                    <div class="text-xs opacity-60 mb-2" x-text="'Pad ' + padNum"></div>
                                    <template x-if="getPadSample(padNum)">
                                        <div>
                                            <div class="text-sm font-semibold truncate" x-text="getPadSample(padNum)?.sample?.title"></div>
                                            <button
                                                class="btn btn-xs btn-error mt-2"
                                                @click.stop="removePadAssignment(padNum)"
                                            >
                                                Remove
                                            </button>
                                        </div>
                                    </template>
                                    <template x-if="!getPadSample(padNum)">
                                        <div class="text-xs opacity-50 italic">Empty</div>
                                    </template>
                                </div>
                            </div>
                        </template>

                        <!-- Row 4: Heart (Pads 13-16) -->
                        <div class="text-right text-xs opacity-60 font-semibold flex items-center justify-end">
                            Heart
                        </div>
                        <template x-for="(label, idx) in ['Kick', 'Snare', 'Hat C', 'Hat O']" :key="idx">
                            <div class="card bg-base-300 hover:bg-base-200 transition-colors cursor-pointer"
                                 @click="showPadRecommendations(13 + idx)">
                                <div class="card-body p-4">
                                    <div class="text-xs opacity-60 mb-1" x-text="'Pad ' + (13 + idx)"></div>
                                    <div class="text-xs font-semibold opacity-80 mb-2" x-text="label"></div>
                                    <template x-if="getPadSample(13 + idx)">
                                        <div>
                                            <div class="text-sm font-semibold truncate" x-text="getPadSample(13 + idx)?.sample?.title"></div>
                                            <button
                                                class="btn btn-xs btn-error mt-2"
                                                @click.stop="removePadAssignment(13 + idx)"
                                            >
                                                Remove
                                            </button>
                                        </div>
                                    </template>
                                    <template x-if="!getPadSample(13 + idx)">
                                        <div class="text-xs opacity-50 italic">Empty</div>
                                    </template>
                                </div>
                            </div>
                        </template>
                    </div>
                </div>
            </div>
        </div>
        </main>
    </template>

    <!-- Create Kit Modal -->
    <dialog id="createKitModal" class="modal">
        <div class="modal-box">
            <h3 class="font-bold text-lg mb-4">Create New Kit</h3>
            <form @submit.prevent="createKit()">
                <div class="form-control mb-4">
                    <label class="label">
                        <span class="label-text">Kit Name</span>
                    </label>
                    <input
                        type="text"
                        x-model="newKit.name"
                        placeholder="My Awesome Kit"
                        class="input input-bordered"
                        required
                        maxlength="255"
                    />
                </div>
                <div class="form-control mb-4">
                    <label class="label">
                        <span class="label-text">Description (optional)</span>
                    </label>
                    <textarea
                        x-model="newKit.description"
                        placeholder="Description of your kit..."
                        class="textarea textarea-bordered"
                        rows="3"
                    ></textarea>
                </div>
                <div class="modal-action">
                    <button type="button" class="btn btn-ghost" @click="closeCreateKitModal()">Cancel</button>
                    <button type="submit" class="btn btn-primary">Create Kit</button>
                </div>
            </form>
        </div>
        <form method="dialog" class="modal-backdrop">
            <button>close</button>
        </form>
    </dialog>

    <!-- Pad Recommendations Modal -->
    <dialog id="recommendationsModal" class="modal">
        <div class="modal-box max-w-2xl">
            <h3 class="font-bold text-lg mb-4">
                Recommendations for Pad <span x-text="recommendationsPad"></span>
            </h3>
            <div class="loading loading-spinner loading-lg mx-auto" x-show="loadingRecommendations"></div>
            <div class="space-y-2 max-h-96 overflow-y-auto" x-show="!loadingRecommendations">
                <template x-for="rec in recommendations" :key="rec.id">
                    <div class="card bg-base-200 hover:bg-base-300 cursor-pointer" @click="assignSampleToPad(rec.id)">
                        <div class="card-body p-4">
                            <div class="flex justify-between items-start">
                                <div class="flex-1">
                                    <h4 class="font-semibold" x-text="rec.title"></h4>
                                    <div class="text-xs opacity-70">
                                        <span x-show="rec.bpm" x-text="rec.bpm + ' BPM'"></span>
                                        <span x-show="rec.genre" x-text="' • ' + rec.genre"></span>
                                    </div>
                                    <div class="text-xs opacity-60 italic mt-1" x-text="rec.recommendation_reason"></div>
                                </div>
                                <button class="btn btn-xs btn-primary" @click.stop="assignSampleToPad(rec.id)">
                                    Assign
                                </button>
                            </div>
                        </div>
                    </div>
                </template>
                <div x-show="recommendations.length === 0 && !loadingRecommendations" class="text-center py-8 opacity-60">
                    No recommendations available
                </div>
            </div>
            <div class="modal-action">
                <button class="btn btn-ghost" @click="closeRecommendationsModal()">Close</button>
            </div>
        </div>
        <form method="dialog" class="modal-backdrop">
            <button>close</button>
        </form>
    </dialog>

    <!-- Alpine.js Component -->
    <script>
        function kitBuilder() {
            return {
                selectedKit: null,
                newKit: { name: '', description: '' },
                recommendations: [],
                recommendationsPad: null,
                loadingRecommendations: false,

                init() {
                    // Check URL for kit_id parameter
                    const urlParams = new URLSearchParams(window.location.search);
                    const kitId = urlParams.get('kit_id');
                    if (kitId) {
                        this.loadKit(kitId);
                    }
                },

                async loadKit(kitId) {
                    try {
                        const response = await fetch(`/api/v1/kits/${kitId}`);
                        if (response.ok) {
                            this.selectedKit = await response.json();
                        }
                    } catch (error) {
                        console.error('Error loading kit:', error);
                    }
                },

                showCreateKitModal() {
                    this.newKit = { name: '', description: '' };
                    document.getElementById('createKitModal').showModal();
                },

                closeCreateKitModal() {
                    document.getElementById('createKitModal').close();
                },

                async createKit() {
                    try {
                        const response = await fetch('/api/v1/kits', {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify(this.newKit)
                        });

                        if (response.ok) {
                            const kit = await response.json();
                            this.closeCreateKitModal();
                            // Refresh kit list
                            htmx.ajax('GET', '/api/v1/kits', { target: '#kit-list', swap: 'innerHTML' });
                            // Open the new kit
                            this.loadKit(kit.id);
                        }
                    } catch (error) {
                        console.error('Error creating kit:', error);
                    }
                },

                async showPadRecommendations(padNumber) {
                    if (!this.selectedKit) return;

                    this.recommendationsPad = padNumber;
                    this.loadingRecommendations = true;
                    this.recommendations = [];
                    document.getElementById('recommendationsModal').showModal();

                    try {
                        const response = await fetch(
                            `/api/v1/kits/${this.selectedKit.id}/recommendations/${padNumber}?limit=20`
                        );
                        if (response.ok) {
                            const data = await response.json();
                            this.recommendations = data.samples;
                        }
                    } catch (error) {
                        console.error('Error loading recommendations:', error);
                    } finally {
                        this.loadingRecommendations = false;
                    }
                },

                closeRecommendationsModal() {
                    document.getElementById('recommendationsModal').close();
                },

                async assignSampleToPad(sampleId) {
                    if (!this.selectedKit || !this.recommendationsPad) return;

                    try {
                        const response = await fetch(`/api/v1/kits/${this.selectedKit.id}/assign`, {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({
                                sample_id: sampleId,
                                pad_bank: 'A',
                                pad_number: this.recommendationsPad,
                                volume: 1.0,
                                pitch_shift: 0
                            })
                        });

                        if (response.ok) {
                            this.closeRecommendationsModal();
                            // Reload kit to show updated assignments
                            await this.loadKit(this.selectedKit.id);
                        }
                    } catch (error) {
                        console.error('Error assigning sample:', error);
                    }
                },

                async removePadAssignment(padNumber) {
                    if (!this.selectedKit) return;

                    const assignment = this.getPadSample(padNumber);
                    if (!assignment) return;

                    try {
                        const response = await fetch(
                            `/api/v1/kits/${this.selectedKit.id}/pads/${assignment.pad_bank}/${padNumber}`,
                            { method: 'DELETE' }
                        );

                        if (response.ok) {
                            // Reload kit to show updated assignments
                            await this.loadKit(this.selectedKit.id);
                        }
                    } catch (error) {
                        console.error('Error removing assignment:', error);
                    }
                },

                getPadSample(padNumber) {
                    if (!this.selectedKit?.samples) return null;
                    return this.selectedKit.samples.find(s => s.pad_number === padNumber);
                },

                async exportKit() {
                    if (!this.selectedKit) return;

                    try {
                        window.location.href = `/api/v1/kits/${this.selectedKit.id}/export?format=wav`;
                    } catch (error) {
                        console.error('Error exporting kit:', error);
                    }
                },

                editKit() {
                    // TODO: Implement edit functionality
                    alert('Edit functionality coming soon!');
                }
            }
        }
    </script>

    <!-- Load sidebar and initialize page -->
    <script>
        // Load sidebar
        fetch('/components/sidebar.html')
            .then(r => r.text())
            .then(html => {
                document.getElementById('sidebar-container').innerHTML = html;

                // Inject kits content into page-content div
                const kitsContent = document.getElementById('kits-content').innerHTML;
                const pageContent = document.getElementById('page-content');
                pageContent.innerHTML = kitsContent;

                // Process HTMX attributes on dynamically injected content
                if (window.htmx) {
                    htmx.process(pageContent);
                }

                // Highlight active page
                highlightActivePage();
            });

        function highlightActivePage() {
            document.querySelectorAll('.drawer-side .menu a').forEach(link => {
                if (link.getAttribute('href') === '/pages/kits.html') {
                    link.classList.add('active', 'bg-primary', 'text-primary-content');
                }
            });
        }
    </script>
</body>
</html>

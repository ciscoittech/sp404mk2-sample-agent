<!DOCTYPE html>
<html lang="en" data-theme="business">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Vibe Search - SP404MK2 Sample Manager</title>

    <!-- DaisyUI + Tailwind -->
    <link href="https://cdn.jsdelivr.net/npm/daisyui@4.12.14/dist/full.min.css" rel="stylesheet">
    <script src="https://cdn.tailwindcss.com"></script>

    <!-- HTMX -->
    <script src="https://unpkg.com/htmx.org@2.0.4"></script>

    <!-- Alpine.js -->
    <script defer src="https://unpkg.com/alpinejs@3.x.x/dist/cdn.min.js"></script>

    <!-- Custom CSS -->
    <link rel="stylesheet" href="/static/css/main.css">
</head>
<body>
    <!-- Include Sidebar -->
    <div id="sidebar-container"></div>

    <!-- Vibe Search Content Template -->
    <template id="vibe-search-content">
        <main class="p-4 lg:p-8" x-data="vibeSearch()">
        <div class="vibe-search-page">
            <!-- Page Header -->
            <div class="mb-8">
                <h1 class="text-3xl font-bold mb-2">
                    <svg class="w-8 h-8 inline-block mr-2 text-primary" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"/>
                    </svg>
                    Vibe Search
                </h1>
                <p class="text-base-content/70">Find samples by describing the vibe you're looking for</p>
            </div>

            <!-- Search Interface -->
            <div class="card bg-base-200 shadow-xl mb-6">
                <div class="card-body">
                    <!-- Main Search Input -->
                    <form @submit.prevent="search()"
                          hx-post="/api/v1/search/vibe"
                          hx-trigger="submit"
                          hx-target="#search-results"
                          hx-indicator="#search-loading">
                        <div class="form-control w-full mb-4">
                            <label class="label">
                                <span class="label-text font-semibold">Describe the vibe</span>
                                <span class="label-text-alt text-xs">
                                    <kbd class="kbd kbd-sm">/</kbd> to focus
                                </span>
                            </label>
                            <div class="relative">
                                <textarea
                                    x-model="query"
                                    @keydown.slash.window.prevent="$el.focus()"
                                    @keydown.escape="query = ''"
                                    name="query"
                                    placeholder="e.g., dark moody trap loops with heavy bass and atmospheric pads..."
                                    class="textarea textarea-bordered textarea-lg w-full resize-none"
                                    rows="3"
                                    required></textarea>
                                <div class="absolute bottom-3 right-3">
                                    <button type="submit" class="btn btn-primary btn-sm gap-2">
                                        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"/>
                                        </svg>
                                        Search
                                    </button>
                                </div>
                            </div>
                        </div>

                        <!-- Quick Vibe Suggestions -->
                        <div class="mb-4">
                            <label class="label">
                                <span class="label-text-alt">Quick suggestions:</span>
                            </label>
                            <div class="flex flex-wrap gap-2">
                                <button type="button" @click="query = 'dark moody loop'" class="badge badge-outline hover:badge-primary cursor-pointer">dark moody loop</button>
                                <button type="button" @click="query = 'energetic trap drums'" class="badge badge-outline hover:badge-primary cursor-pointer">energetic trap drums</button>
                                <button type="button" @click="query = 'chill jazzy rhodes'" class="badge badge-outline hover:badge-primary cursor-pointer">chill jazzy rhodes</button>
                                <button type="button" @click="query = 'aggressive 808 bass'" class="badge badge-outline hover:badge-primary cursor-pointer">aggressive 808 bass</button>
                                <button type="button" @click="query = 'vintage soul sample'" class="badge badge-outline hover:badge-primary cursor-pointer">vintage soul sample</button>
                                <button type="button" @click="query = 'ambient atmospheric pad'" class="badge badge-outline hover:badge-primary cursor-pointer">ambient atmospheric pad</button>
                            </div>
                        </div>

                        <!-- Advanced Filters (Collapsible) -->
                        <div class="collapse collapse-arrow bg-base-300 rounded-lg" :class="{ 'collapse-open': showFilters }">
                            <input type="checkbox" x-model="showFilters" />
                            <div class="collapse-title font-medium">
                                <svg class="w-4 h-4 inline-block mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6V4m0 2a2 2 0 100 4m0-4a2 2 0 110 4m-6 8a2 2 0 100-4m0 4a2 2 0 110-4m0 4v2m0-6V4m6 6v10m6-2a2 2 0 100-4m0 4a2 2 0 110-4m0 4v2m0-6V4"/>
                                </svg>
                                Advanced Filters
                            </div>
                            <div class="collapse-content">
                                <div class="grid grid-cols-1 md:grid-cols-2 gap-4 pt-2">
                                    <!-- BPM Range -->
                                    <div class="form-control">
                                        <label class="label">
                                            <span class="label-text">BPM Range</span>
                                            <span class="label-text-alt" x-text="`${filters.bpm_min} - ${filters.bpm_max}`"></span>
                                        </label>
                                        <input type="hidden" name="bpm_min" :value="filters.bpm_min">
                                        <input type="hidden" name="bpm_max" :value="filters.bpm_max">
                                        <div class="flex gap-4 items-center">
                                            <input type="range" x-model="filters.bpm_min" min="60" max="180" class="range range-primary range-sm" step="5">
                                            <input type="range" x-model="filters.bpm_max" min="60" max="180" class="range range-primary range-sm" step="5">
                                        </div>
                                        <div class="w-full flex justify-between text-xs px-2 mt-1">
                                            <span>60</span>
                                            <span>120</span>
                                            <span>180</span>
                                        </div>
                                    </div>

                                    <!-- Energy Level -->
                                    <div class="form-control">
                                        <label class="label">
                                            <span class="label-text">Energy Level</span>
                                            <span class="label-text-alt" x-text="`${filters.energy_min} - ${filters.energy_max}`"></span>
                                        </label>
                                        <input type="hidden" name="energy_min" :value="filters.energy_min">
                                        <input type="hidden" name="energy_max" :value="filters.energy_max">
                                        <div class="flex gap-4 items-center">
                                            <input type="range" x-model="filters.energy_min" min="0" max="100" class="range range-accent range-sm" step="10">
                                            <input type="range" x-model="filters.energy_max" min="0" max="100" class="range range-accent range-sm" step="10">
                                        </div>
                                        <div class="w-full flex justify-between text-xs px-2 mt-1">
                                            <span>Low</span>
                                            <span>Medium</span>
                                            <span>High</span>
                                        </div>
                                    </div>

                                    <!-- Danceability -->
                                    <div class="form-control">
                                        <label class="label">
                                            <span class="label-text">Danceability</span>
                                            <span class="label-text-alt" x-text="`${filters.danceability_min} - ${filters.danceability_max}`"></span>
                                        </label>
                                        <input type="hidden" name="danceability_min" :value="filters.danceability_min">
                                        <input type="hidden" name="danceability_max" :value="filters.danceability_max">
                                        <div class="flex gap-4 items-center">
                                            <input type="range" x-model="filters.danceability_min" min="0" max="100" class="range range-success range-sm" step="10">
                                            <input type="range" x-model="filters.danceability_max" min="0" max="100" class="range range-success range-sm" step="10">
                                        </div>
                                    </div>

                                    <!-- Genre Multi-Select -->
                                    <div class="form-control">
                                        <label class="label">
                                            <span class="label-text">Genres</span>
                                        </label>
                                        <div class="flex flex-wrap gap-2">
                                            <template x-for="genre in ['hip-hop', 'trap', 'jazz', 'soul', 'electronic', 'house']" :key="genre">
                                                <label class="label cursor-pointer gap-2 bg-base-100 px-3 py-1 rounded-lg">
                                                    <input type="checkbox" :name="`genre_${genre}`" :value="genre" class="checkbox checkbox-sm" />
                                                    <span class="label-text capitalize" x-text="genre"></span>
                                                </label>
                                            </template>
                                        </div>
                                    </div>
                                </div>

                                <div class="mt-4 flex gap-2 justify-end">
                                    <button type="button" @click="resetFilters()" class="btn btn-sm btn-ghost">Reset Filters</button>
                                    <button type="submit" class="btn btn-sm btn-primary">Apply Filters</button>
                                </div>
                            </div>
                        </div>
                    </form>
                </div>
            </div>

            <!-- Recent Searches -->
            <div x-show="recentSearches.length > 0" class="mb-6">
                <div class="flex justify-between items-center mb-2">
                    <h3 class="font-semibold text-sm">Recent Searches</h3>
                    <button @click="clearRecentSearches()" class="btn btn-xs btn-ghost">Clear</button>
                </div>
                <div class="flex flex-wrap gap-2">
                    <template x-for="search in recentSearches" :key="search">
                        <button @click="query = search; $refs.searchForm.submit()" class="badge badge-lg badge-ghost gap-2 cursor-pointer">
                            <svg class="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"/>
                            </svg>
                            <span x-text="search"></span>
                        </button>
                    </template>
                </div>
            </div>

            <!-- Search Loading State -->
            <div id="search-loading" class="htmx-indicator mb-6">
                <div class="flex flex-col items-center justify-center py-12">
                    <span class="loading loading-spinner loading-lg text-primary mb-4"></span>
                    <p class="text-base-content/70">Analyzing vibe and searching samples...</p>
                </div>
            </div>

            <!-- Results Stats Bar -->
            <div id="results-stats" class="stats stats-horizontal shadow mb-6 hidden">
                <div class="stat">
                    <div class="stat-title">Results</div>
                    <div class="stat-value text-2xl" id="result-count">0</div>
                    <div class="stat-desc">samples found</div>
                </div>
                <div class="stat">
                    <div class="stat-title">Avg Match</div>
                    <div class="stat-value text-2xl text-primary" id="avg-similarity">0%</div>
                    <div class="stat-desc">similarity score</div>
                </div>
                <div class="stat">
                    <div class="stat-title">BPM Range</div>
                    <div class="stat-value text-2xl" id="bpm-range">--</div>
                    <div class="stat-desc">detected range</div>
                </div>
                <div class="stat">
                    <div class="stat-title">Top Genre</div>
                    <div class="stat-value text-2xl" id="top-genre">--</div>
                    <div class="stat-desc">most common</div>
                </div>
            </div>

            <!-- Sort Options -->
            <div id="sort-options" class="flex justify-between items-center mb-4 hidden">
                <div>
                    <select class="select select-bordered select-sm" @change="sortResults($event.target.value)">
                        <option value="similarity">Sort: Similarity</option>
                        <option value="bpm">Sort: BPM</option>
                        <option value="recent">Sort: Recent</option>
                        <option value="energy">Sort: Energy</option>
                    </select>
                </div>
                <div class="flex gap-2">
                    <button @click="exportResults()" class="btn btn-sm btn-ghost gap-2">
                        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 10v6m0 0l-3-3m3 3l3-3m2 8H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"/>
                        </svg>
                        Export CSV
                    </button>
                    <button @click="feelingLucky()" class="btn btn-sm btn-accent gap-2">
                        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11.049 2.927c.3-.921 1.603-.921 1.902 0l1.519 4.674a1 1 0 00.95.69h4.915c.969 0 1.371 1.24.588 1.81l-3.976 2.888a1 1 0 00-.363 1.118l1.518 4.674c.3.922-.755 1.688-1.538 1.118l-3.976-2.888a1 1 0 00-1.176 0l-3.976 2.888c-.783.57-1.838-.197-1.538-1.118l1.518-4.674a1 1 0 00-.363-1.118l-3.976-2.888c-.784-.57-.38-1.81.588-1.81h4.914a1 1 0 00.951-.69l1.519-4.674z"/>
                        </svg>
                        I'm Feeling Lucky
                    </button>
                </div>
            </div>

            <!-- Search Results Grid -->
            <div id="search-results" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4 min-h-[200px]">
                <!-- Empty State -->
                <div class="col-span-full text-center py-16">
                    <div class="max-w-md mx-auto">
                        <svg class="w-24 h-24 mx-auto mb-4 text-base-content/30" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"/>
                        </svg>
                        <h3 class="text-xl font-semibold mb-2">Start Your Vibe Search</h3>
                        <p class="text-base-content/70 mb-4">Describe the vibe you're looking for in natural language. Our AI will find samples that match your description.</p>
                        <div class="text-sm text-base-content/60">
                            <p><strong>Try:</strong> "dark atmospheric loop with heavy reverb"</p>
                            <p><strong>Or:</strong> "upbeat trap drums around 140 BPM"</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        </main>
    </template>

    <!-- Load sidebar and initialize page -->
    <script>
        // Alpine.js Vibe Search Component
        function vibeSearch() {
            return {
                query: '',
                results: [],
                loading: false,
                showFilters: false,
                recentSearches: [],
                filters: {
                    bpm_min: 60,
                    bpm_max: 180,
                    energy_min: 0,
                    energy_max: 100,
                    danceability_min: 0,
                    danceability_max: 100
                },

                init() {
                    // Load recent searches from localStorage
                    const stored = localStorage.getItem('vibe_recent_searches');
                    if (stored) {
                        this.recentSearches = JSON.parse(stored).slice(0, 5);
                    }

                    // Setup keyboard shortcuts
                    this.setupKeyboardShortcuts();
                },

                search() {
                    this.loading = true;

                    // Add to recent searches
                    if (this.query && !this.recentSearches.includes(this.query)) {
                        this.recentSearches.unshift(this.query);
                        this.recentSearches = this.recentSearches.slice(0, 5);
                        localStorage.setItem('vibe_recent_searches', JSON.stringify(this.recentSearches));
                    }

                    // Show stats bar
                    document.getElementById('results-stats')?.classList.remove('hidden');
                    document.getElementById('sort-options')?.classList.remove('hidden');
                },

                resetFilters() {
                    this.filters = {
                        bpm_min: 60,
                        bpm_max: 180,
                        energy_min: 0,
                        energy_max: 100,
                        danceability_min: 0,
                        danceability_max: 100
                    };
                },

                clearRecentSearches() {
                    this.recentSearches = [];
                    localStorage.removeItem('vibe_recent_searches');
                },

                sortResults(sortBy) {
                    // TODO: Implement client-side sorting
                    console.log('Sorting by:', sortBy);
                },

                exportResults() {
                    // TODO: Export results to CSV
                    console.log('Exporting results...');
                },

                feelingLucky() {
                    // Random vibe suggestion
                    const suggestions = [
                        'dark moody loop',
                        'energetic trap drums',
                        'chill jazzy rhodes',
                        'aggressive 808 bass',
                        'vintage soul sample',
                        'ambient atmospheric pad'
                    ];
                    this.query = suggestions[Math.floor(Math.random() * suggestions.length)];
                    this.$refs.searchForm?.submit();
                },

                setupKeyboardShortcuts() {
                    document.addEventListener('keydown', (e) => {
                        // Escape to clear search
                        if (e.key === 'Escape' && document.activeElement.tagName === 'TEXTAREA') {
                            this.query = '';
                        }
                    });
                }
            }
        }

        // Load sidebar
        fetch('/components/sidebar.html')
            .then(r => r.text())
            .then(html => {
                document.getElementById('sidebar-container').innerHTML = html;

                // Inject vibe search content
                const vibeSearchContent = document.getElementById('vibe-search-content').innerHTML;
                const pageContent = document.getElementById('page-content');
                pageContent.innerHTML = vibeSearchContent;

                // Process HTMX attributes
                if (window.htmx) {
                    htmx.process(pageContent);
                }

                // Highlight active page
                highlightActivePage();
            });

        function highlightActivePage() {
            document.querySelectorAll('.drawer-side .menu a').forEach(link => {
                if (link.getAttribute('href') === '/pages/vibe-search.html') {
                    link.classList.add('active', 'bg-primary', 'text-primary-content');
                }
            });
        }
    </script>
</body>
</html>

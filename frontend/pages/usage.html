{% extends "components/base.html" %}

{% block title %}API Usage & Costs - SP404MK2{% endblock %}

{% block head %}
    <!-- Chart.js for usage graphs -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
{% endblock %}

{% block content %}
    <!-- Usage Dashboard Content -->
    <div x-data="usageData()">
        <!-- Page Header -->
        <div class="mb-8">
            <h1 class="text-3xl font-bold mb-2">OpenRouter API Usage & Costs</h1>
            <p class="text-base-content/70">Track your AI model spending and token usage</p>
        </div>

        <!-- Budget Alert -->
        <div x-show="budgetData.status === 'warning'" class="alert alert-warning mb-6">
            <svg xmlns="http://www.w3.org/2000/svg" class="stroke-current shrink-0 h-6 w-6" fill="none" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z" />
            </svg>
            <div>
                <div class="font-bold">Budget Warning</div>
                <div class="text-sm" x-text="budgetData.warnings.join(', ')"></div>
            </div>
        </div>

        <div x-show="budgetData.status === 'exceeded'" class="alert alert-error mb-6">
            <svg xmlns="http://www.w3.org/2000/svg" class="stroke-current shrink-0 h-6 w-6" fill="none" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 14l2-2m0 0l2-2m-2 2l-2-2m2 2l2 2m7-2a9 9 0 11-18 0 9 9 0 0118 0z" />
            </svg>
            <div>
                <div class="font-bold">Budget Exceeded!</div>
                <div class="text-sm" x-text="budgetData.warnings.join(', ')"></div>
            </div>
        </div>

        <!-- Summary Cards -->
        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4 mb-8">
            <!-- Total Cost This Month -->
            <div class="card bg-base-100 shadow-xl">
                <div class="card-body">
                    <h2 class="card-title text-sm">üí∞ Total Spend (Month)</h2>
                    <p class="text-3xl font-bold" x-text="'$' + summary.total_cost.toFixed(4)">$0.0000</p>
                    <div class="text-sm text-base-content/70">
                        <span x-text="summary.call_count">0</span> API calls
                    </div>
                </div>
            </div>

            <!-- Token Usage -->
            <div class="card bg-base-100 shadow-xl">
                <div class="card-body">
                    <h2 class="card-title text-sm">üî¢ Tokens Used</h2>
                    <p class="text-3xl font-bold" x-text="summary.total_tokens.toLocaleString()">0</p>
                    <div class="text-sm text-base-content/70">
                        <span x-text="summary.input_tokens.toLocaleString()">0</span> in /
                        <span x-text="summary.output_tokens.toLocaleString()">0</span> out
                    </div>
                </div>
            </div>

            <!-- Budget Remaining -->
            <div class="card bg-base-100 shadow-xl">
                <div class="card-body">
                    <h2 class="card-title text-sm">üìä Budget Status</h2>
                    <p class="text-3xl font-bold"
                       x-text="'$' + budgetData.monthly.remaining.toFixed(2)"
                       :class="budgetData.monthly.percentage > 0.8 ? 'text-error' : ''">
                        $10.00
                    </p>
                    <div class="text-sm text-base-content/70">
                        <span x-text="(budgetData.monthly.percentage * 100).toFixed(1)">0</span>% of budget used
                    </div>
                    <progress class="progress w-full"
                              :class="{
                                  'progress-success': budgetData.monthly.percentage < 0.5,
                                  'progress-warning': budgetData.monthly.percentage >= 0.5 && budgetData.monthly.percentage < 0.8,
                                  'progress-error': budgetData.monthly.percentage >= 0.8
                              }"
                              :value="budgetData.monthly.percentage * 100"
                              max="100"></progress>
                </div>
            </div>

            <!-- Top Model -->
            <div class="card bg-base-100 shadow-xl">
                <div class="card-body">
                    <h2 class="card-title text-sm">ü§ñ Top Model</h2>
                    <p class="text-xl font-bold truncate" x-text="topModel.name">-</p>
                    <div class="text-sm text-base-content/70">
                        $<span x-text="topModel.cost.toFixed(4)">0.0000</span> ‚Ä¢
                        <span x-text="topModel.count">0</span> calls
                    </div>
                </div>
            </div>
        </div>

        <!-- Charts -->
        <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-8">
            <!-- Operation Breakdown -->
            <div class="card bg-base-100 shadow-xl">
                <div class="card-body">
                    <h2 class="card-title">üí∏ Cost Breakdown by Operation</h2>
                    <div class="h-64">
                        <canvas id="operationChart"></canvas>
                    </div>
                </div>
            </div>

            <!-- Daily Cost Trend -->
            <div class="card bg-base-100 shadow-xl">
                <div class="card-body">
                    <h2 class="card-title">üìà Daily Cost (Last 30 Days)</h2>
                    <div class="h-64">
                        <canvas id="dailyChart"></canvas>
                    </div>
                </div>
            </div>
        </div>

        <!-- Model Comparison Table -->
        <div class="card bg-base-100 shadow-xl mb-6">
            <div class="card-body">
                <h2 class="card-title mb-4">üîç Model Comparison</h2>
                <div class="overflow-x-auto">
                    <table class="table table-sm">
                        <thead>
                            <tr>
                                <th>Model</th>
                                <th>Calls</th>
                                <th>Tokens</th>
                                <th>Cost</th>
                                <th>Avg Cost/Call</th>
                            </tr>
                        </thead>
                        <tbody>
                            <template x-for="model in modelsList" :key="model.name">
                                <tr>
                                    <td class="font-mono text-xs" x-text="model.name"></td>
                                    <td x-text="model.count"></td>
                                    <td x-text="model.tokens.toLocaleString()"></td>
                                    <td>$<span x-text="model.cost.toFixed(4)"></span></td>
                                    <td>$<span x-text="model.avgCost.toFixed(4)"></span></td>
                                </tr>
                            </template>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

        <!-- Recent API Calls -->
        <div class="card bg-base-100 shadow-xl mb-6">
            <div class="card-body">
                <div class="flex justify-between items-center mb-4">
                    <h2 class="card-title">üìã Recent API Calls (Last 50)</h2>
                    <a href="/api/v1/usage/export" class="btn btn-sm btn-outline gap-2">
                        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 10v6m0 0l-3-3m3 3l3-3m2 8H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"/>
                        </svg>
                        Export CSV
                    </a>
                </div>
                <div class="overflow-x-auto">
                    <table class="table table-sm">
                        <thead>
                            <tr>
                                <th>Time</th>
                                <th>Model</th>
                                <th>Operation</th>
                                <th>Tokens (in/out)</th>
                                <th>Cost</th>
                            </tr>
                        </thead>
                        <tbody>
                            <template x-for="call in recentCalls" :key="call.id">
                                <tr>
                                    <td class="text-xs" x-text="new Date(call.created_at).toLocaleString()"></td>
                                    <td class="text-xs" x-text="call.model"></td>
                                    <td>
                                        <span class="badge badge-sm" x-text="call.operation"></span>
                                    </td>
                                    <td class="text-xs">
                                        <span x-text="call.total_tokens"></span>
                                        <span class="text-base-content/50">
                                            (<span x-text="call.input_tokens"></span>/<span x-text="call.output_tokens"></span>)
                                        </span>
                                    </td>
                                    <td class="text-xs">$<span x-text="call.total_cost.toFixed(4)"></span></td>
                                </tr>
                            </template>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
{% endblock %}

{% block scripts %}
    <!-- Alpine.js Data Component for Usage Dashboard -->
    <script>
        function usageData() {
            return {
                summary: {
                    total_cost: 0,
                    total_tokens: 0,
                    input_tokens: 0,
                    output_tokens: 0,
                    call_count: 0,
                    by_operation: {},
                    by_model: {}
                },
                budgetData: {
                    status: 'ok',
                    warnings: [],
                    monthly: {
                        used: 0,
                        limit: 10,
                        percentage: 0,
                        remaining: 10
                    },
                    daily: {
                        tokens_used: 0,
                        tokens_limit: 100000,
                        percentage: 0,
                        tokens_remaining: 100000
                    }
                },
                dailyData: [],
                recentCalls: [],
                operationChart: null,
                dailyChart: null,

                init() {
                    this.loadData();
                    // Auto-refresh every 30 seconds
                    setInterval(() => this.loadData(), 30000);
                },

                async loadData() {
                    try {
                        // Load all data from public endpoints (no auth required)
                        const [summaryRes, dailyRes, recentRes] = await Promise.all([
                            fetch('/api/v1/public/usage/summary'),
                            fetch('/api/v1/public/usage/daily?days=30'),
                            fetch('/api/v1/public/usage/recent?limit=50')
                        ]);

                        // Parse summary and budget
                        const data = await summaryRes.json();
                        this.summary = data.summary;
                        this.budgetData = data.budget;

                        // Parse daily data
                        if (dailyRes.ok) {
                            const daily = await dailyRes.json();
                            this.dailyData = daily.data;
                            this.updateDailyChart();
                        }

                        // Parse recent calls
                        if (recentRes.ok) {
                            const recent = await recentRes.json();
                            this.recentCalls = recent.calls;
                        }

                        // Update operation chart
                        this.updateOperationChart();

                    } catch (error) {
                        console.error('Error loading usage data:', error);
                    }
                },

                get topModel() {
                    const models = Object.entries(this.summary.by_model);
                    if (models.length === 0) return { name: '-', cost: 0, count: 0 };

                    const [name, data] = models.reduce((max, current) =>
                        current[1].cost > max[1].cost ? current : max
                    );

                    return { name, cost: data.cost, count: data.count };
                },

                get modelsList() {
                    return Object.entries(this.summary.by_model).map(([name, data]) => ({
                        name,
                        count: data.count,
                        tokens: data.tokens,
                        cost: data.cost,
                        avgCost: data.count > 0 ? data.cost / data.count : 0
                    })).sort((a, b) => b.cost - a.cost);
                },

                updateOperationChart() {
                    const ctx = document.getElementById('operationChart');
                    if (!ctx) return;

                    const operations = this.summary.by_operation;
                    const labels = Object.keys(operations);
                    const data = Object.values(operations).map(op => op.cost);

                    if (this.operationChart) {
                        this.operationChart.destroy();
                    }

                    this.operationChart = new Chart(ctx, {
                        type: 'doughnut',
                        data: {
                            labels: labels,
                            datasets: [{
                                data: data,
                                backgroundColor: [
                                    'rgba(255, 99, 132, 0.8)',
                                    'rgba(54, 162, 235, 0.8)',
                                    'rgba(255, 206, 86, 0.8)',
                                    'rgba(75, 192, 192, 0.8)',
                                ]
                            }]
                        },
                        options: {
                            responsive: true,
                            maintainAspectRatio: false,
                            plugins: {
                                legend: {
                                    position: 'bottom',
                                    labels: { color: '#fff' }
                                },
                                tooltip: {
                                    callbacks: {
                                        label: (context) => {
                                            return context.label + ': $' + context.parsed.toFixed(4);
                                        }
                                    }
                                }
                            }
                        }
                    });
                },

                updateDailyChart() {
                    const ctx = document.getElementById('dailyChart');
                    if (!ctx) return;

                    const labels = this.dailyData.map(d => d.date);
                    const data = this.dailyData.map(d => d.cost);

                    if (this.dailyChart) {
                        this.dailyChart.destroy();
                    }

                    this.dailyChart = new Chart(ctx, {
                        type: 'line',
                        data: {
                            labels: labels,
                            datasets: [{
                                label: 'Cost (USD)',
                                data: data,
                                borderColor: 'rgba(54, 162, 235, 1)',
                                backgroundColor: 'rgba(54, 162, 235, 0.2)',
                                tension: 0.4,
                                fill: true
                            }]
                        },
                        options: {
                            responsive: true,
                            maintainAspectRatio: false,
                            plugins: {
                                legend: { display: false },
                                tooltip: {
                                    callbacks: {
                                        label: (context) => {
                                            return '$' + context.parsed.y.toFixed(4);
                                        }
                                    }
                                }
                            },
                            scales: {
                                y: {
                                    beginAtZero: true,
                                    grid: { color: 'rgba(255, 255, 255, 0.1)' },
                                    ticks: {
                                        color: '#fff',
                                        callback: (value) => '$' + value.toFixed(2)
                                    }
                                },
                                x: {
                                    grid: { color: 'rgba(255, 255, 255, 0.1)' },
                                    ticks: { color: '#fff' }
                                }
                            }
                        }
                    });
                }
            }
        }
    </script>
{% endblock %}
